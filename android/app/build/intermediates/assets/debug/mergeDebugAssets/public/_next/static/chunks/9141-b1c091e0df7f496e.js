"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9141],{28051:(e,t,r)=>{r.d(t,{As:()=>g,O7:()=>u,R1:()=>d,zp:()=>p});var o=r(19056),n=r(5282),a=r(80160);let i="workwell-therapeutic-notebook",s="".concat("https://emotiva--workwell-c4rlk.europe-west4.hosted.app/","/save-notebook-entry");async function l(e,t){try{let r={userId:e,entryData:t};console.log("--- DEBUG: Informaci\xf3n de la llamada API para guardar en el cuaderno ---"),console.log("URL Destino (Proxy Interno):",s),console.log("M\xe9todo HTTP:","POST"),console.log("Payload (Cuerpo de la petici\xf3n):",JSON.stringify(r,null,2)),console.log("--------------------------------------------------------------------");let o=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}),n=await o.json();o.ok?console.log("[Client] Notebook entry for user '".concat(e,"' sync initiated successfully.")):console.error("[Client] Notebook sync failed with status: ".concat(o.status,"."),n)}catch(e){console.error("[Client] Error calling internal notebook sync API:",e)}}function c(){try{let e=localStorage.getItem(i);return(e?JSON.parse(e):[]).sort((e,t)=>(0,o.H)(t.timestamp).getTime()-(0,o.H)(e.timestamp).getTime())}catch(e){return console.error("Error reading notebook entries from localStorage:",e),[]}}function u(e){return c().find(t=>t.id===e)}function d(e){let{userId:t,...r}=e,o={id:crypto.randomUUID(),timestamp:new Date().toISOString(),...r};try{{let e=c(),t=[o,...e].slice(0,100);localStorage.setItem(i,JSON.stringify(t)),window.dispatchEvent(new CustomEvent("notebook-updated"))}}catch(e){console.error("Error saving notebook entry to localStorage:",e)}return t?l(t,{id:o.id,timestamp:o.timestamp,title:o.title,content:o.content,pathId:o.pathId,ruta:o.ruta}):console.warn("addNotebookEntry: userId not provided, skipping external sync."),o}function p(e){try{let t=[...e].sort((e,t)=>{try{return(0,o.H)(t.timestamp).getTime()-(0,o.H)(e.timestamp).getTime()}catch(r){try{return new Date(t.timestamp.replace(" ","T")).getTime()-new Date(e.timestamp.replace(" ","T")).getTime()}catch(r){return console.warn("Could not parse timestamps for sorting in overwriteNotebookEntries:",t.timestamp,e.timestamp),0}}}).slice(0,100);localStorage.setItem(i,JSON.stringify(t))}catch(e){console.error("Error overwriting notebook entries in localStorage:",e)}}function g(e){if(!e)return"Fecha no disponible";try{let t=(0,o.H)(e);if(!isNaN(t.getTime()))return(0,n.GP)(t,"dd MMM yyyy, HH:mm",{locale:a.es});let r=new Date(e.replace(" ","T"));if(!isNaN(r.getTime()))return(0,n.GP)(r,"dd MMM yyyy, HH:mm",{locale:a.es});return console.error("Error critical formatting entry timestamp: Invalid date string provided -",e),"Fecha inv\xe1lida"}catch(t){return console.error("Error formatting entry timestamp:",t,"Input:",e),"Fecha inv\xe1lida"}}},29141:(e,t,r)=>{r.d(t,{J:()=>k,UserProvider:()=>v});var o=r(95155),n=r(12115),a=r(59253),i=r(1554),s=r(19708),l=r(20063),c=r(15894),u=r(50168),d=r(9891),p=r(86501),g=r(15742),m=r(28051),y=r(47599),f=r(82257),h=r(26549);let w=(0,n.createContext)(void 0),S="".concat(h.T,"/wp-content/programacion/wscontenido.php");async function b(e){let t=new Date().toISOString().slice(0,19).replace("T"," "),r=btoa("".concat("SJDFgfds788sdfs8888KLLLL","|").concat(t)),o=btoa(e),n="".concat(S,"?apikey=").concat("4463","&tipo=getcuaderno&usuario=").concat(encodeURIComponent(o),"&token=").concat(encodeURIComponent(r));try{let e,t=await fetch(n,{cache:"no-store"});if(!t.ok){let e=await t.text();return console.error("Error fetching notebook:",e),{entries:[],debugUrl:n}}let r=(await t.text()).trim();r.startsWith("{")&&r.endsWith("}")&&(r="[".concat(r.replace(/}\s*{/g,"},{"),"]"));try{let t=JSON.parse(r);Array.isArray(t)&&t.length>0?"status"in t[0]?(e=t[0],console.log("UserContext: Processed concatenated JSON response, taking first object.")):(e={status:"OK",data:t},console.log("UserContext: Processed concatenated JSON as a direct data array.")):e=t}catch(o){let t=(0,f.xW)(r);if(!Array.isArray(t))return console.error("Failed to parse notebook response as JSON or decrypt it:",r),{entries:[],debugUrl:n};e={status:"OK",data:t}}if(Array.isArray(e)&&(e={status:"OK",data:e}),"OK"===e.status){let t=null;if(Array.isArray(e.data))t=e.data;else if("string"==typeof e.data&&""!==e.data.trim()){let r=(0,f.xW)(e.data);Array.isArray(r)&&(t=r)}if(t)return{entries:t.map(e=>Array.isArray(e)&&e.length>=5?{id:String(e[0]),timestamp:String(e[1]),title:String(e[3]),content:String(e[4]),pathId:e[5]?String(e[5]):void 0,ruta:e[5]?String(e[5]).replace(/-/g," ").charAt(0).toUpperCase()+String(e[5]).slice(1).replace(/-/g," "):void 0}:"object"==typeof e&&null!==e&&"id"in e&&"timestamp"in e?{id:String(e.id),timestamp:String(e.timestamp),title:String(e.title||""),content:String(e.content||""),pathId:e.pathId?String(e.pathId):e.ruta?String(e.ruta):void 0,ruta:e.ruta?String(e.ruta):e.pathId?String(e.pathId).replace(/-/g," ").charAt(0).toUpperCase()+String(e.pathId).slice(1).replace(/-/g," "):void 0}:(console.warn("Unrecognized notebook item format:",e),null)).filter(e=>null!==e),debugUrl:n}}return console.warn("Could not find notebook data in API response:",e),{entries:[],debugUrl:n}}catch(e){return console.error("Failed to fetch or process notebook:",e),{entries:[],debugUrl:n}}}function v(e){let{children:t}=e,[r,f]=(0,n.useState)(null),[h,S]=(0,n.useState)(!0),[v,k]=(0,n.useState)([]),[E,I]=(0,n.useState)(!1),A=(0,l.useRouter)(),C=(0,i.As)(),U=(0,i.jt)(),{toast:T}=(0,c.dj)(),N=(0,n.useCallback)(async e=>{if(!e)return;I(!0);let{entries:t,debugUrl:r}=await b(e);(0,m.zp)(t),k(t),sessionStorage.setItem("workwell-debug-notebook-fetch-url",r),window.dispatchEvent(new Event("notebook-url-updated")),I(!1)},[]),O=(0,n.useCallback)(async e=>{if(!U||!e)return;let t=(0,s.H9)(U,"users",e);try{let r=await (0,s.x7)(t);if(r.exists()){let t=r.data();f(r=>({...r,id:e,name:t.name||(null==r?void 0:r.name)||"Usuario",email:t.email||(null==r?void 0:r.email),ageRange:t.ageRange||null,gender:t.gender||null,initialEmotionalState:t.initialEmotionalState||null}))}}catch(e){d.d.emit("permission-error",new p.$({path:t.path,operation:"get"}))}},[U]);(0,n.useEffect)(()=>{if(!C||!U)return void S(!1);let e=(0,a.hg)(C,async e=>{if(e){S(!0);try{let t={id:e.uid,name:e.displayName||"Usuario",email:e.email};f(t),await O(e.uid),N(e.uid)}catch(e){console.error("Failed to initialize user session:",e)}finally{S(!1)}}else f(null),k([]),S(!1)});return()=>e()},[C,U,O,N]),(0,n.useEffect)(()=>{let e=()=>{(null==r?void 0:r.id)&&N(r.id)};return window.addEventListener("notebook-updated",e),()=>{window.removeEventListener("notebook-updated",e)}},[null==r?void 0:r.id,N]);let P=(0,n.useCallback)(async()=>{if(C)try{await (0,a.CI)(C),f(null),k([]),localStorage.clear(),sessionStorage.clear(),A.push("/login")}catch(e){console.error("Error signing out: ",e)}},[A,C]),x=(0,n.useCallback)(async e=>{if(!r||!r.id||!U)return;let t=(0,s.H9)(U,"users",r.id);(0,g.wu)(t,{...e,updatedAt:new Date().toISOString()},{merge:!0}),f(t=>t?{...t,...e}:null)},[r,U]),H=(0,n.useCallback)(async()=>{let e=null==C?void 0:C.currentUser;if(!e||!U){let e="Usuario no autenticado o base de datos no disponible.";return T({title:u.t.deleteAccountErrorTitle,description:e,variant:"destructive"}),{success:!1,error:e}}let t=e.uid;try{let{debugUrl:r}=await (0,y.$9)(t,"borrarusuario");sessionStorage.setItem("workwell-debug-delete-fetch-url",r);let o=(0,s.wP)(U);for(let e of["emotional_entries","notebook_entries","psychologicalAssessments","userRoutes","userPreferences","journalEntries","emotionalCheckIns","userProfiles"]){let r=(0,s.rJ)(U,"users",t,e);try{(await (0,s.GG)(r)).forEach(e=>{o.delete(e.ref)})}catch(e){return d.d.emit("permission-error",new p.$({path:r.path,operation:"list"})),{success:!1,error:"Error listing user sub-collections for deletion."}}}let n=(0,s.H9)(U,"users",t);return o.delete(n),await o.commit().catch(e=>{throw d.d.emit("permission-error",new p.$({path:"users/".concat(t),operation:"delete"})),e}),await (0,a.hG)(e),T({title:u.t.deleteAccountSuccessTitle,description:u.t.deleteAccountSuccessMessage}),P(),{success:!0}}catch(t){let e=u.t.deleteAccountErrorMessage;return"auth/requires-recent-login"===t.code&&(e="Esta operaci\xf3n es sensible y requiere una autenticaci\xf3n reciente. Por favor, cierra sesi\xf3n y vuelve a iniciarla antes de intentarlo de nuevo."),"FirebaseError"!==t.name&&T({title:u.t.deleteAccountErrorTitle,description:e,variant:"destructive"}),{success:!1,error:e}}},[C,U,P,T,u.t]);return(0,o.jsx)(w.Provider,{value:{user:r,loading:h,logout:P,updateUser:x,fetchUserProfile:O,deleteUserAccount:H,notebookEntries:v,fetchAndSetNotebook:N,isNotebookLoading:E},children:t})}function k(){let e=(0,n.useContext)(w);if(void 0===e)throw Error("useUser must be used within a UserProvider");return e}}}]);